<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Currency Converter</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icons/css/flag-icons.min.css">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Poppins', Arial, sans-serif;
      background: transparent;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    #converter {
      background: #ffffff; 
      background-size: 100% 100%;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      max-width: 100%;
      width: 100%;
      padding: 24px;
      margin: 0;
      border: 1px solid #e8ecef;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      font-family: 'Poppins', Arial, sans-serif;
      position: relative;
      overflow: hidden;
    }
    #converter:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
    }
    .section-header {
      font-size: 16px;
      font-weight: 600;
      color: #2A6AFF;
      margin: 16px 0 8px;
      text-align: left;
    }
    .input-group {
      margin-bottom: 16px;
    }
    .input-row {
      display: flex;
      align-items: center;
      background: #f8fafc;
      border-radius: 12px;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      transition: border-color 0.2s ease;
    }
    .input-row:focus-within {
      border-color: #2A6AFF;
    }
    .input-row label {
      min-width: 100px;
      font-size: 14px;
      font-weight: 500;
      color: #2A6AFF;
      margin-right: 8px;
      font-family: 'Poppins', Arial, sans-serif;
    }
    .input-row input[type="number"],
    .input-row input[type="text"] {
      border: none;
      background: transparent;
      font-size: 20px;
      font-weight: 600;
      color: #1a1a1a;
      width: 100%;
      padding: 10px 0;
      text-align: right;
      outline: none;
      font-family: 'Poppins', Arial, sans-serif;
    }
    .input-row input[type="number"]::-webkit-input-placeholder,
    .input-row input[type="text"]::-webkit-input-placeholder {
      color: #94a3b8;
      font-weight: 400;
    }
    .input-row select {
      width: 130px;
      min-width: 120px;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      font-size: 15px;
      background: #ffffff;
      font-family: inherit;
      margin-left: 8px;
      margin-right: 4px;
      transition: border-color 0.2s ease, background 0.2s ease;
    }
    .input-row select:focus {
      border-color: #2A6AFF;
      background: #f8fafc;
      outline: none;
    }
    .select2-container .select2-selection--single {
      height: 40px;
      min-width: 120px;
      width: 130px !important;
      display: flex;
      align-items: center;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      background: #ffffff;
      padding-right: 8px;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
      line-height: 40px;
      font-size: 15px;
      color: #1a1a1a;
      padding-left: 6px;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
      height: 40px;
    }
    .rate-pill {
      display: inline-block;
      background: #f0f4ff;
      color: #2A6AFF;
      font-size: 14px;
      font-weight: 500;
      border-radius: 12px;
      padding: 6px 16px;
      margin: 12px 0;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
      text-align: center;
      margin-left: auto;
      margin-right: auto;
      display: block;
      font-family: 'Poppins', Arial, sans-serif;
    }
    .discount-note {
      background: #f0f4ff;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 13px;
      color: #2A6AFF;
      border-left: 3px solid #2A6AFF;
      margin: 12px 0;
      font-weight: 500;
      text-align: left;
    }
    #send-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      background: linear-gradient(90deg, #4CCDF6 0%, #2A6AFF 100%);
      color: #ffffff;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
      font-family: 'Poppins', Arial, sans-serif;
    }
    #send-btn:hover {
      background: linear-gradient(90deg, #2A6AFF 0%, #4CCDF6 100%);
      transform: translateY(-1px);
    }
    #send-btn:active {
      transform: translateY(0);
    }
    #minmax-note {
      font-size: 12px;
      color: #4b5563;
      margin-top: 4px;
      text-align: left;
    }
    #delivery-window {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 12px;
      text-align: left;
    }
    .rate-guaranteed {
      font-size: 12px;
      color: #2A6AFF;
      text-align: center;
      margin: 0 auto 8px auto;
      font-weight: 500;
      display: block;
    }
    .loader-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 10;
    }
    .loader-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 11;
    }
    .spinner {
      border: 4px solid #e2e8f0;
      border-top: 4px solid #2A6AFF;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width: 600px) {
      body {
        padding: 0;
      }
      #converter {
        max-width: 100%;
        padding: 16px;
        border-radius: 12px;
        box-shadow: none;
        border: none;
      }
      .section-header {
        font-size: 14px;
        margin: 12px 0 6px;
      }
      .input-group {
        margin-bottom: 12px;
      }
      .input-row {
        padding: 6px 8px;
        border-radius: 10px;
      }
      .input-row label {
        min-width: 80px;
        font-size: 13px;
      }
      .input-row input[type="number"],
      .input-row input[type="text"] {
        font-size: 16px;
        padding: 8px 0;
      }
      .input-row select {
        width: 110px;
        min-width: 100px;
        font-size: 14px;
        padding: 8px 10px;
        margin-right: 4px;
      }
      .select2-container .select2-selection--single {
        height: 36px;
        min-width: 100px;
        width: 110px !important;
      }
      .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 36px;
        font-size: 14px;
      }
      .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 36px;
      }
      .rate-pill {
        font-size: 12px;
        padding: 5px 12px;
        margin: 8px 0;
      }
      .discount-note {
        font-size: 12px;
        padding: 8px 12px;
      }
      #send-btn {
        font-size: 14px;
        padding: 12px;
        border-radius: 10px;
      }
      #minmax-note,
      #delivery-window {
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <div id="converter">
    <p class="rate-guaranteed">ⓘ Rate guaranteed (2h)</p>
    <p class="rate-pill" id="rate-info"></p>
    <div class="input-group">
      <div class="input-row">
        <label for="amount">You send</label>
        <input type="number" id="amount" value="1000" min="1">
        <select id="send-country">
          <!-- Populated dynamically -->
        </select>
      </div>
      <span id="minmax-note"></span>
    </div>
    <div class="discount-note" id="discount-note">Min: - , Max: -</div>
    <div class="input-group">
      <div class="input-row">
        <label for="converted-amount" style="white-space: nowrap;">Recipient gets</label>
        <input type="text" id="converted-amount" value="" readonly>
        <select id="receive-country">
          <!-- Populated dynamically -->
        </select>
      </div>
    </div>
    <div id="delivery-window"></div>
    <a href="https://app.spennx.com/" target="_blank" rel="noopener noreferrer" id="send-btn" style="display: flex; align-items: center; justify-content: center; text-decoration: none;">Send money</a>
    <div id="loader" style="display:none;">
      <div class="loader-backdrop"></div>
      <div class="loader-spinner">
        <div class="spinner"></div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    const sendCountryEl = document.getElementById("send-country");
    const receiveCountryEl = document.getElementById("receive-country");
    const amountEl = document.getElementById("amount");
    const convertedAmountEl = document.getElementById("converted-amount");
    const rateInfoEl = document.getElementById("rate-info");
    const minmaxNoteEl = document.getElementById("minmax-note");
    const discountNoteEl = document.getElementById("discount-note");
    const deliveryWindowEl = document.getElementById("delivery-window");
    const loaderEl = document.getElementById("loader");

    let ratesMap = {};
    let minSend = null, maxSend = null;
    let currentRate = null;
    let currentSendCurrency = null;
    let currentReceiveCurrency = null;
    let currentReceiveCountry = null;
    let currentDeliveryWindow = null;

    const TOKEN = "EgG3833LRAjxHMqxRpa9X7uymSeCgK";
    const API_BASE = "https://app.spennx.com/api/v1";

    function fetchWithToken(url) {
      return fetch(url, {
        method: "GET",
        headers: {
          "Authorization": `Bearer ${TOKEN}`,
          "Content-Type": "application/json"
        }
      }).then(res => res.json());
    }

    // Currency to country mapping for origin countries
    const currencyToCountryMap = {
      'USD': 'US',
      'CAD': 'CA',
      'GBP': 'GB',
      'NGN': 'NG',
      'NOK': 'NO',
      'EUR': 'DE', 
      'KES': 'KE',
      'GHS': 'GH',
      'ZAR': 'ZA',
      'EGP': 'EG',
      'MAD': 'MA',
      'TND': 'TN',
      'DZD': 'DZ',
      'ETB': 'ET',
      'UGX': 'UG',
      'TZS': 'TZ',
      'RWF': 'RW',
      'XOF': 'SN',  
      'XAF': 'CM',  
      'INR': 'IN',
      'PKR': 'PK',
      'BDT': 'BD',
      'LKR': 'LK',
      'NPR': 'NP',
      'CNY': 'CN',
      'JPY': 'JP',
      'KRW': 'KR',
      'SGD': 'SG',
      'MYR': 'MY',
      'THB': 'TH',
      'VND': 'VN',
      'IDR': 'ID',
      'PHP': 'PH',
      'AUD': 'AU',
      'NZD': 'NZ',
      'BRL': 'BR',
      'ARS': 'AR',
      'CLP': 'CL',
      'COP': 'CO',
      'PEN': 'PE',
      'MXN': 'MX'
    };

    function populateSendCountries() {
      sendCountryEl.innerHTML = '';
      const countries = [
        {iso2: 'CA', name: 'Canada', currency: 'CAD', currencySymbol: '$', flag: 'ca'},   
        {iso2: 'GB', name: 'British Pound', currency: 'GBP', currencySymbol: '£', flag: 'gb'}, 
        {iso2: 'NG', name: 'Nigeria', currency: 'NGN', currencySymbol: '₦', flag: 'ng'},
        {iso2: 'NO', name: 'Norway', currency: 'NOK', currencySymbol: 'kr', flag: 'no'}, 
        {iso2: 'US', name: 'United States', currency: 'USD', currencySymbol: '$', flag: 'us'}, 
      ];
      countries.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.iso2;
        opt.textContent = `${c.currency}`;
        opt.setAttribute('data-currency', c.currency);
        opt.setAttribute('data-currency-symbol', c.currencySymbol);
        opt.setAttribute('data-flag', c.flag);
        sendCountryEl.appendChild(opt);
      });
      const defaultSender = 'US';
      if ([...sendCountryEl.options].some(opt => opt.value === defaultSender)) {
        sendCountryEl.value = defaultSender;
      }
      
      // Initialize Select2 first, then trigger the change event
      $('#send-country').select2({
        templateResult: function (state) {
          if (!state.id) return state.text;
          var flag = $(state.element).data('flag');
          return $('<span><span class="fi fi-' + flag + '" style="margin-right:8px;"></span>' + state.text + '</span>');
        },
        templateSelection: function (state) {
          if (!state.id) return state.text;
          var flag = $(state.element).data('flag');
          return $('<span><span class="fi fi-' + flag + '" style="margin-right:8px;"></span>' + state.text + '</span>');
        },
        minimumResultsForSearch: -1
      });
      
      // Trigger the change event after Select2 is initialized to make the API call
      setTimeout(() => {
        console.log('Triggering initial API call for default currency:', defaultSender);
        $('#send-country').trigger('change');
      }, 100);
    }

    function updateSenderCurrencyLabel(currency) {
      const label = document.querySelector('label[for="amount"]');
      if (label) {
        label.textContent = `You send`;
      }
    }

    function showLoader() {
      if (loaderEl) loaderEl.style.display = 'flex';
    }
    function hideLoader() {
      if (loaderEl) loaderEl.style.display = 'none';
    }

    $(document).ready(function() {
      // Set up the change event handler first
      $('#send-country').on('change', function() {
        const iso2 = this.value;
        currentSendCurrency = iso2;
        console.log('Send country changed to:', iso2);
        
        // Get currency from selected option
        const selectedOpt = this.options[this.selectedIndex];
        const senderCurrency = selectedOpt.getAttribute('data-currency') || '';
        updateSenderCurrencyLabel(senderCurrency);
        showLoader();
        
        fetchWithToken(`${API_BASE}/currencies/${iso2}`).then(res => {  
          console.log(`API response for ${iso2}:`, res);
          
          let matchedObj = null; 
          if (Array.isArray(res)) {
            for (let obj of res) {
              if (obj.currency === senderCurrency) {
                matchedObj = obj;
                break;
              }
            }
          } else if (res && typeof res === 'object') { 
            if (Array.isArray(res.data)) {
              for (let obj of res.data) {
                if (obj.currency === senderCurrency) {
                  matchedObj = obj;
                  break;
                }
              }
              if (!matchedObj && res.data.length > 0) {
                matchedObj = res.data[0];
              }
            } else if (res.currency === senderCurrency) {
              matchedObj = res;
            } else if (res && res.settings) {
              matchedObj = res;
            }
          }
          if (!matchedObj) {
            if (Array.isArray(res) && res.length > 0) {
              matchedObj = res[0];
            } else if (res && Array.isArray(res.data) && res.data.length > 0) {
              matchedObj = res.data[0];
            }
          }
          
          console.log(`Matched object for ${iso2}:`, matchedObj);
          
          const intl = matchedObj?.settings?.international_remittance || [];
          console.log(`International remittance data for ${iso2}:`, intl);
          
          ratesMap = {};
          receiveCountryEl.innerHTML = "";
          
          // Filter for unique currencies from their origin countries
          const uniqueCurrencies = new Map();
          
          console.log('Processing international remittance items...');
          intl.forEach((item, index) => {
            const currency = item.currency;
            const itemIso2 = (item.iso2 || item.country_iso2 || '').toUpperCase();
            const originCountry = currencyToCountryMap[currency];
            
            console.log(`Item ${index}: currency=${currency}, itemIso2=${itemIso2}, originCountry=${originCountry}, rate=${item.rate}, hasLimit=${!!item.limit}, hasDeliveryWindows=${!!item.delivery_windows}`);
            
            // More flexible matching - prioritize currency mapping over iso2 matching
            if (originCountry) {
              const itemToAdd = {
                ...item,
                iso2: originCountry // Use the mapped country iso2
              };
              
              // If we already have this currency, compare and keep the better one
              if (uniqueCurrencies.has(currency)) {
                const existing = uniqueCurrencies.get(currency);
                console.log(`Currency ${currency} already exists. Comparing...`);
                console.log(`Existing: rate=${existing.rate}, hasLimit=${!!existing.limit}, hasDeliveryWindows=${!!existing.delivery_windows}`);
                console.log(`New: rate=${item.rate}, hasLimit=${!!item.limit}, hasDeliveryWindows=${!!item.delivery_windows}`);
                
                const shouldReplace = 
                  (!existing.rate && item.rate) ||  
                  (existing.rate && item.rate && item.rate > 0 && (!existing.rate || existing.rate <= 0)) ||  
                  (itemIso2 === originCountry && (existing.iso2 !== originCountry || !existing.rate)) || 
                  (!existing.limit && item.limit) ||  
                  (!existing.delivery_windows && item.delivery_windows);  
                
                if (shouldReplace) {
                  console.log(`✅ Replacing existing ${currency} with better data`);
                  uniqueCurrencies.set(currency, itemToAdd);
                } else {
                  console.log(`⏭️ Keeping existing ${currency} data`);
                }
              } else {
                console.log(`✅ Adding new currency ${currency} to dropdown`);
                uniqueCurrencies.set(currency, itemToAdd);
              }
            } else {
              console.log(`❌ Skipping currency ${currency}: no origin country mapping found`);
            }
          });
          
          console.log('Final unique currencies:', Array.from(uniqueCurrencies.keys()));
          console.log('Final unique currencies with details:', Array.from(uniqueCurrencies.entries()).map(([currency, data]) => ({
            currency, 
            rate: data.rate, 
            iso2: data.iso2,
            hasLimit: !!data.limit,
            hasDeliveryWindows: !!data.delivery_windows
          })));
          
          // Convert Map to array and sort by currency code
          let filteredItems = Array.from(uniqueCurrencies.values()).sort((a, b) => a.currency.localeCompare(b.currency));
          
          console.log(`Filtered items count: ${filteredItems.length}`);
          if (filteredItems.length > 0) {
            console.log('Sample filtered items:', filteredItems.slice(0, 5).map(item => ({
              currency: item.currency,
              rate: item.rate,
              iso2: item.iso2,
              hasLimit: !!item.limit
            })));
          }
          
          // If no filtered items, add all available currencies as fallback
          if (filteredItems.length === 0 && intl.length > 0) {
            console.log('No filtered items found, adding all available currencies as fallback');
            uniqueCurrencies.clear(); // Clear the map first
            intl.forEach(item => {
              const currency = item.currency;
              if (!uniqueCurrencies.has(currency)) {
                // Use the item's iso2 or fallback to currency mapping
                const itemIso2 = (item.iso2 || item.country_iso2 || '').toUpperCase();
                const fallbackIso2 = currencyToCountryMap[currency] || itemIso2 || currency.substring(0, 2);
                
                console.log(`Fallback: Adding ${currency} with iso2: ${fallbackIso2}`);
                uniqueCurrencies.set(currency, {
                  ...item,
                  iso2: fallbackIso2
                });
              }
            });
            filteredItems = Array.from(uniqueCurrencies.values()).sort((a, b) => a.currency.localeCompare(b.currency));
            console.log('Fallback filtered items:', filteredItems.length);
          }
          
          // Populate the dropdown with filtered unique currencies
          console.log('Populating dropdown with', filteredItems.length, 'items');
          filteredItems.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item.iso2;
            opt.textContent = item.currency;
            let flagIso = item.iso2.toLowerCase();
            opt.setAttribute('data-flag', flagIso);
            receiveCountryEl.appendChild(opt);
            ratesMap[item.iso2] = item;
            console.log(`Added to dropdown: ${item.currency} (${item.iso2})`);
          });
          
          console.log('RatesMap after population:', Object.keys(ratesMap));
          // Destroy previous Select2 instance if exists
          if ($.fn.select2 && $('#receive-country').data('select2')) {
            $('#receive-country').select2('destroy');
          }
          // Initialize Select2 for receiver dropdown with flag and currency
          setTimeout(() => {
            if (filteredItems.length > 0) {
              // Auto-select the first receive country before initializing Select2
              receiveCountryEl.value = filteredItems[0].iso2;
              console.log('Auto-selected receive country:', filteredItems[0].iso2, filteredItems[0].currency);
            }
            
            $('#receive-country').select2({
              templateResult: function (state) {
                if (!state.id) return state.text;
                var flag = $(state.element).data('flag');
                return $('<span><span class="fi fi-' + flag + '" style="margin-right:8px;"></span>' + state.text + '</span>');
              },
              templateSelection: function (state) {
                if (!state.id) return state.text;
                var flag = $(state.element).data('flag');
                return $('<span><span class="fi fi-' + flag + '" style="margin-right:8px;"></span>' + state.text + '</span>');
              },
              minimumResultsForSearch: -1
            });
            
            // Trigger change event after Select2 is initialized
            if (filteredItems.length > 0) {
              console.log('Triggering change event for receive country');
              $('#receive-country').trigger('change');
            }
          }, 100);
          // Set min/max from the first available filtered recipient (if any)
          if (filteredItems.length > 0) {
            const first = filteredItems[0];
            minSend = first.limit?.min || null;
            maxSend = first.limit?.max || null;
            console.log('Set min/max from first item:', {minSend, maxSend, currency: first.currency});
          } else {
            minSend = null;
            maxSend = null;
            console.log('No filtered items, min/max set to null');
          }
          updateMinMaxNote();
          updateDiscountNote();
          hideLoader();
        }).catch(error => {
          console.error('Error fetching currency data:', error);
          hideLoader();
        });
      });

      $('#receive-country').on('change', function() {
        showLoader();
        const iso2 = this.value;
        const item = ratesMap[iso2];
        console.log(`Receive country changed to: ${iso2}`);
        console.log(`Looking for item in ratesMap with key: ${iso2}`);
        console.log(`Found item:`, item);
        
        if (item) {
          currentRate = item.rate;
          currentReceiveCurrency = item.currency;
          currentReceiveCountry = item.country;
          minSend = item.limit?.min || null;
          maxSend = item.limit?.max || null;
          
          console.log(`Set current values: rate=${currentRate}, currency=${currentReceiveCurrency}, country=${currentReceiveCountry}`);
          console.log(`Set limits: min=${minSend}, max=${maxSend}`);
          
          if (item.delivery_windows && item.delivery_windows.length > 0) {
            let fastest = item.delivery_windows[0];
            for (let win of item.delivery_windows) {
              if (parseInt((win.duration||'').replace(/\D/g,'')) < parseInt((fastest.duration||'').replace(/\D/g,''))) {
                fastest = win;
              }
            }
            currentDeliveryWindow = fastest;
            console.log(`Set delivery window:`, currentDeliveryWindow);
          } else {
            currentDeliveryWindow = null;
            console.log('No delivery windows found');
          }
        } else {
          console.log(`❌ No item found in ratesMap for ${iso2}`);
          currentRate = null;
          currentReceiveCurrency = null;
          currentReceiveCountry = null;
          currentDeliveryWindow = null;
        }
        updateMinMaxNote();
        updateDiscountNote();
        updateConversion();
        setTimeout(hideLoader, 350);
      });

      // Initialize the send countries dropdown and trigger initial API call
      populateSendCountries();
    });

    function updateMinMaxNote() {
      if (minSend && maxSend) {
        minmaxNoteEl.textContent = `Min: ${minSend}, Max: ${maxSend}`;
      } else {
        minmaxNoteEl.textContent = '';
      }
    }

    function updateDiscountNote() {
      if (minSend && maxSend) {
        discountNoteEl.textContent = `You can send between ${minSend} and ${maxSend}`;
      } else {
        discountNoteEl.textContent = '';
      }
    }

    function updateConversion() {
      const amount = parseFloat(amountEl.value);
      console.log(`🔄 updateConversion called:`);
      console.log(`  - Send amount: ${amount}`);
      console.log(`  - Current rate: ${currentRate}`);
      console.log(`  - Min send: ${minSend}, Max send: ${maxSend}`);
      console.log(`  - Current receive currency: ${currentReceiveCurrency}`);
      
      // Clear any previous error messages
      const existingError = document.getElementById('limit-error');
      if (existingError) {
        existingError.remove();
      }
      
      if (currentRate && amount && (!minSend || amount >= minSend) && (!maxSend || amount <= maxSend)) {
        const converted = (amount * currentRate);
        const roundedConverted = Math.round(converted);
        
        console.log(`  ✅ Conversion successful:`);
        console.log(`    - Raw converted amount: ${converted}`);
        console.log(`    - Rounded converted amount: ${roundedConverted}`);
        console.log(`    - Formatted converted amount: ${roundedConverted.toLocaleString()}`);
        
        // Format with comma separators, no decimal places
        convertedAmountEl.value = roundedConverted.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        
        // Get the sender currency for display
        const selectedSendOpt = sendCountryEl.options[sendCountryEl.selectedIndex];
        const senderCurrency = selectedSendOpt?.getAttribute('data-currency') || currentSendCurrency || '';
        
        // Format the rate with 3 decimal places
        const formattedRate = currentRate.toLocaleString(undefined, {minimumFractionDigits: 3, maximumFractionDigits: 3});
        rateInfoEl.textContent = `1 ${senderCurrency} = ${formattedRate} ${currentReceiveCurrency || ''}`;

        console.log(`      - Rate display: 1 ${senderCurrency} = ${formattedRate} ${currentReceiveCurrency || ''}`);
        
        if (currentDeliveryWindow && currentDeliveryWindow.duration) {
          deliveryWindowEl.textContent = `Estimated delivery: ${currentDeliveryWindow.duration}`;
          console.log(`    - Delivery: ${currentDeliveryWindow.duration}`);
        } else {
          deliveryWindowEl.textContent = '';
          console.log(`    - No delivery window`);
        }
      } else {
        console.log(`  ❌ Conversion failed - conditions not met:`);
        console.log(`    - Has rate: ${!!currentRate}`);
        console.log(`    - Has amount: ${!!amount}`);
        console.log(`    - Amount >= min: ${!minSend || amount >= minSend} (min: ${minSend})`);
        console.log(`    - Amount <= max: ${!maxSend || amount <= maxSend} (max: ${maxSend})`);
        
        convertedAmountEl.value = '';
        rateInfoEl.textContent = '';
        deliveryWindowEl.textContent = '';
        
        // Show specific error message for limit violations
        if (currentRate && amount) {
          let errorMessage = '';
          const senderCurrency = sendCountryEl.options[sendCountryEl.selectedIndex]?.getAttribute('data-currency') || '';
          
          if (minSend && amount < minSend) {
            errorMessage = `⚠️ Minimum send amount is ${minSend} ${senderCurrency}. Please increase your amount.`;
          } else if (maxSend && amount > maxSend) {
            errorMessage = `⚠️ Maximum send amount is ${maxSend} ${senderCurrency}. Please decrease your amount.`;
          }
          
          if (errorMessage) {
            // Create and show error message
            const errorDiv = document.createElement('div');
            errorDiv.id = 'limit-error';
            errorDiv.style.cssText = `
              background: #fef2f2;
              color: #dc2626;
              padding: 8px 12px;
              border-radius: 8px;
              font-size: 13px;
              font-weight: 500;
              margin: 8px 0;
              border: 1px solid #fecaca;
              text-align: center;
            `;
            errorDiv.textContent = errorMessage;
            
            // Insert after the amount input
            const amountGroup = document.querySelector('.input-group');
            amountGroup.appendChild(errorDiv);
            
            console.log(`  📢 Showing limit error: ${errorMessage}`);
          }
        }
      }
    }

    amountEl.addEventListener("input", updateConversion);
  </script>
</body>
</html>