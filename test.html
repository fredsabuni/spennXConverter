<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Currency Converter</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icons/css/flag-icons.min.css">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: transparent;
      font-family: 'Inter', Arial, sans-serif;
    }
    #converter {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      width: 100%;
      max-width: 400px;
      min-height: 100%;
      padding: 24px;
      border: 1px solid #e8ecef;
      transition: box-shadow 0.2s ease;
      margin: 0 auto;
    }
    #converter:hover {
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
    }
    .section-header {
      font-size: 16px;
      font-weight: 600;
      color: #1e40af;
      margin: 16px 0 8px;
      text-align: left;
    }
    .input-group {
      margin-bottom: 16px;
    }
    .input-row {
      display: flex;
      align-items: center;
      background: #f8fafc;
      border-radius: 12px;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      transition: border-color 0.2s ease;
    }
    .input-row:focus-within {
      border-color: #1e40af;
    }
    .input-row label {
      min-width: 100px;
      font-size: 14px;
      font-weight: 500;
      color: #1e40af;
      margin-right: 8px;
    }
    .input-row input[type="number"],
    .input-row input[type="text"] {
      border: none;
      background: transparent;
      font-size: 20px;
      font-weight: 600;
      color: #1a1a1a;
      width: 100%;
      padding: 10px 0;
      text-align: right;
      outline: none;
    }
    .input-row input[type="number"]::-webkit-input-placeholder,
    .input-row input[type="text"]::-webkit-input-placeholder {
      color: #94a3b8;
      font-weight: 400;
    }
    .input-row select {
      width: 80px;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      font-size: 14px;
      background: #ffffff;
      font-family: inherit;
      margin-left: 8px;
      transition: border-color 0.2s ease, background 0.2s ease;
    }
    .input-row select:focus {
      border-color: #1e40af;
      background: #f8fafc;
      outline: none;
    }
    .select2-container .select2-selection--single {
      height: 36px;
      display: flex;
      align-items: center;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      background: #ffffff;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
      line-height: 36px;
      font-size: 14px;
      color: #1a1a1a;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
      height: 36px;
    }
    .rate-pill {
      display: inline-block;
      background: #e0e7ff;
      color: #1e40af;
      font-size: 14px;
      font-weight: 500;
      border-radius: 12px;
      padding: 6px 16px;
      margin: 12px 0;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
    }
    .discount-note {
      background: #f0f4ff;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 13px;
      color: #1e40af;
      border-left: 3px solid #1e40af;
      margin: 12px 0;
      font-weight: 500;
      text-align: left;
    }
    #send-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      background: linear-gradient(90deg, #1e40af 0%, #3b82f6 100%);
      color: #ffffff;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    #send-btn:hover {
      background: linear-gradient(90deg, #3b82f6 0%, #1e40af 100%);
      transform: translateY(-1px);
    }
    #send-btn:active {
      transform: translateY(0);
    }
    #minmax-note {
      font-size: 12px;
      color: #4b5563;
      margin-top: 4px;
      text-align: left;
    }
    #delivery-window {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 12px;
      text-align: left;
    }
    .rate-guaranteed {
      font-size: 12px;
      color: #1e40af;
      text-align: left;
      margin: 0 0 8px;
      font-weight: 500;
    }
    .loader-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 10;
    }
    .loader-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 11;
    }
    .spinner {
      border: 4px solid #e2e8f0;
      border-top: 4px solid #1e40af;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width: 600px) {
      #converter {
        max-width: 100%;
        padding: 16px;
        border-radius: 12px;
        box-shadow: none;
        border: none;
      }
      .section-header {
        font-size: 14px;
        margin: 12px 0 6px;
      }
      .input-group {
        margin-bottom: 12px;
      }
      .input-row {
        padding: 6px 8px;
        border-radius: 10px;
      }
      .input-row label {
        min-width: 80px;
        font-size: 13px;
      }
      .input-row input[type="number"],
      .input-row input[type="text"] {
        font-size: 16px;
        padding: 8px 0;
      }
      .input-row select {
        width: 70px;
        font-size: 13px;
        padding: 6px;
      }
      .select2-container .select2-selection--single {
        height: 32px;
      }
      .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 32px;
        font-size: 13px;
      }
      .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 32px;
      }
      .rate-pill {
        font-size: 12px;
        padding: 5px 12px;
        margin: 8px 0;
      }
      .discount-note {
        font-size: 12px;
        padding: 8px 12px;
      }
      #send-btn {
        font-size: 14px;
        padding: 12px;
        border-radius: 10px;
      }
      #minmax-note,
      #delivery-window {
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <div id="converter">
    <p class="rate-guaranteed">ⓘ Rate guaranteed (2h)</p>
    <p class="rate-pill" id="rate-info"></p>
    <div class="input-group">
      <div class="input-row">
        <label for="amount">You send</label>
        <input type="number" id="amount" value="1000" min="1">
        <select id="send-country">
          <!-- Populated dynamically -->
        </select>
      </div>
      <span id="minmax-note"></span>
    </div>
    <div class="discount-note" id="discount-note">Min: - , Max: -</div>
    <div class="input-group">
      <div class="input-row">
        <label for="converted-amount">Recipient gets</label>
        <input type="text" id="converted-amount" value="" readonly>
        <select id="receive-country">
          <!-- Populated dynamically -->
        </select>
      </div>
    </div>
    <div id="delivery-window"></div>
    <button id="send-btn">Send money</button>
    <div id="loader" style="display:none;">
      <div class="loader-backdrop"></div>
      <div class="loader-spinner">
        <div class="spinner"></div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    const sendCountryEl = document.getElementById("send-country");
    const receiveCountryEl = document.getElementById("receive-country");
    const amountEl = document.getElementById("amount");
    const convertedAmountEl = document.getElementById("converted-amount");
    const rateInfoEl = document.getElementById("rate-info");
    const minmaxNoteEl = document.getElementById("minmax-note");
    const discountNoteEl = document.getElementById("discount-note");
    const deliveryWindowEl = document.getElementById("delivery-window");
    const loaderEl = document.getElementById("loader");

    let ratesMap = {};
    let minSend = null, maxSend = null;
    let currentRate = null;
    let currentSendCurrency = null;
    let currentReceiveCurrency = null;
    let currentReceiveCountry = null;
    let currentDeliveryWindow = null;

    const TOKEN = "EgG3833LRAjxHMqxRpa9X7uymSeCgK";
    const API_BASE = "https://app.spennx.com/api/v1";

    function fetchWithToken(url) {
      return fetch(url, {
        method: "GET",
        headers: {
          "Authorization": `Bearer ${TOKEN}`,
          "Content-Type": "application/json"
        }
      }).then(res => res.json());
    }

    function populateSendCountries() {
      sendCountryEl.innerHTML = '';
      const countries = [
        {iso2: 'CA', name: 'Canada', currency: 'CAD', currencySymbol: '$', flag: 'ca'},   
        {iso2: 'GB', name: 'British Pound', currency: 'GBP', currencySymbol: '£', flag: 'gb'}, 
        {iso2: 'NG', name: 'Nigeria', currency: 'NGN', currencySymbol: '₦', flag: 'ng'},
        {iso2: 'NO', name: 'Norway', currency: 'NOK', currencySymbol: 'kr', flag: 'no'}, 
        {iso2: 'US', name: 'United States', currency: 'USD', currencySymbol: '$', flag: 'us'}, 
      ];
      countries.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.iso2;
        opt.textContent = `${c.currency}`;
        opt.setAttribute('data-currency', c.currency);
        opt.setAttribute('data-currency-symbol', c.currencySymbol);
        opt.setAttribute('data-flag', c.flag);
        sendCountryEl.appendChild(opt);
      });
      const defaultSender = 'NG';
      if ([...sendCountryEl.options].some(opt => opt.value === defaultSender)) {
        sendCountryEl.value = defaultSender;
      }
      sendCountryEl.dispatchEvent(new Event('change'));
      setTimeout(() => {
        $('#send-country').select2({
          templateResult: function (state) {
            if (!state.id) return state.text;
            var flag = $(state.element).data('flag');
            return $('<span><span class="fi fi-' + flag + '" style="margin-right:8px;"></span>' + state.text + '</span>');
          },
          templateSelection: function (state) {
            if (!state.id) return state.text;
            var flag = $(state.element).data('flag');
            return $('<span><span class="fi fi-' + flag + '" style="margin-right:8px;"></span>' + state.text + '</span>');
          },
          minimumResultsForSearch: -1
        });
      }, 0);
    }

    function updateSenderCurrencyLabel(currency) {
      const label = document.querySelector('label[for="amount"]');
      if (label) {
        label.textContent = `You send`;
      }
    }

    function showLoader() {
      if (loaderEl) loaderEl.style.display = 'flex';
    }
    function hideLoader() {
      if (loaderEl) loaderEl.style.display = 'none';
    }

    $(document).ready(function() {
      $('#send-country').on('change', function() {
        const iso2 = this.value;
        currentSendCurrency = iso2;
        const selectedOpt = this.options[this.selectedIndex];
        const senderCurrency = selectedOpt.getAttribute('data-currency') || '';
        updateSenderCurrencyLabel(senderCurrency);
        showLoader();
        fetchWithToken(`${API_BASE}/currencies/${iso2}`).then(res => {
          let matchedObj = null;
          if (Array.isArray(res)) {
            for (let obj of res) {
              if (obj.currency === senderCurrency) {
                matchedObj = obj;
                break;
              }
            }
          }
          if (!matchedObj && Array.isArray(res.data) && res.data.length > 0) {
            matchedObj = res.data[0];
          }
          const intl = matchedObj?.settings?.international_remittance || [];
          ratesMap = {};
          receiveCountryEl.innerHTML = "";
          intl.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item.iso2;
            opt.textContent = item.currency;
            let flagIso = (item.iso2 || item.country_iso2 || '').toLowerCase();
            opt.setAttribute('data-flag', flagIso);
            receiveCountryEl.appendChild(opt);
            ratesMap[item.iso2] = item;
          });
          if ($.fn.select2 && $('#receive-country').data('select2')) {
            $('#receive-country').select2('destroy');
          }
          setTimeout(() => {
            $('#receive-country').select2({
              templateResult: function (state) {
                if (!state.id) return state.text;
                var flag = $(state.element).data('flag');
                return $('<span><span class="fi fi-' + flag + '" style="margin-right:8px;"></span>' + state.text + '</span>');
              },
              templateSelection: function (state) {
                if (!state.id) return state.text;
                var flag = $(state.element).data('flag');
                return $('<span><span class="fi fi-' + flag + '" style="margin-right:8px;"></span>' + state.text + '</span>');
              },
              minimumResultsForSearch: -1
            });
          }, 0);
          if (intl.length > 0) {
            const first = intl[0];
            minSend = first.limit?.min || null;
            maxSend = first.limit?.max || null;
          } else {
            minSend = null;
            maxSend = null;
          }
          updateMinMaxNote();
          updateDiscountNote();
          receiveCountryEl.dispatchEvent(new Event('change'));
          hideLoader();
        });
      });

      $('#receive-country').on('change', function() {
        showLoader();
        const iso2 = this.value;
        const item = ratesMap[iso2];
        if (item) {
          currentRate = item.rate;
          currentReceiveCurrency = item.currency;
          currentReceiveCountry = item.country;
          minSend = item.limit?.min || null;
          maxSend = item.limit?.max || null;
          if (item.delivery_windows && item.delivery_windows.length > 0) {
            let fastest = item.delivery_windows[0];
            for (let win of item.delivery_windows) {
              if (parseInt((win.duration||'').replace(/\D/g,'')) < parseInt((fastest.duration||'').replace(/\D/g,''))) {
                fastest = win;
              }
            }
            currentDeliveryWindow = fastest;
          } else {
            currentDeliveryWindow = null;
          }
        } else {
          currentRate = null;
          currentReceiveCurrency = null;
          currentReceiveCountry = null;
          currentDeliveryWindow = null;
        }
        updateMinMaxNote();
        updateDiscountNote();
        updateConversion();
        setTimeout(hideLoader, 350);
      });
    });

    function updateMinMaxNote() {
      if (minSend && maxSend) {
        minmaxNoteEl.textContent = `Min: ${minSend}, Max: ${maxSend}`;
      } else {
        minmaxNoteEl.textContent = '';
      }
    }

    function updateDiscountNote() {
      if (minSend && maxSend) {
        discountNoteEl.textContent = `You can send between ${minSend} and ${maxSend}`;
      } else {
        discountNoteEl.textContent = '';
      }
    }

    function updateConversion() {
      const amount = parseFloat(amountEl.value);
      if (currentRate && amount && (!minSend || amount >= minSend) && (!maxSend || amount <= maxSend)) {
        const converted = (amount * currentRate).toFixed(2);
        convertedAmountEl.value = converted;
        rateInfoEl.textContent = `1 ${currentSendCurrency || ''} = ${currentRate} ${currentReceiveCurrency || ''}`;
        if (currentDeliveryWindow && currentDeliveryWindow.duration) {
          deliveryWindowEl.textContent = `Estimated delivery: ${currentDeliveryWindow.duration}`;
        } else {
          deliveryWindowEl.textContent = '';
        }
      } else {
        convertedAmountEl.value = '';
        rateInfoEl.textContent = '';
        deliveryWindowEl.textContent = '';
      }
    }

    amountEl.addEventListener("input", updateConversion);
    populateSendCountries();
  </script>
</body>
</html>